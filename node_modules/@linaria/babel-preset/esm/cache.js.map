{"version":3,"file":"cache.js","names":["createHash","linariaLogger","getFileIdx","hashContent","content","update","digest","cacheLogger","extend","cacheNames","loggers","reduce","acc","key","TransformCacheCollection","contentHashes","Map","constructor","caches","entrypoints","exports","add","cacheName","value","cache","toString","padStart","has","get","set","clear","forEach","name","delete","invalidate","res","undefined","invalidateForFile","filename","invalidateIfChanged","hash","newHash"],"sources":["../src/cache.ts"],"sourcesContent":["import { createHash } from 'crypto';\n\nimport { linariaLogger } from '@linaria/logger';\nimport { getFileIdx } from '@linaria/utils';\n\nimport type { Entrypoint } from './transform/Entrypoint';\nimport type { IEvaluatedEntrypoint } from './transform/EvaluatedEntrypoint';\n\nfunction hashContent(content: string) {\n  return createHash('sha256').update(content).digest('hex');\n}\n\ninterface ICaches {\n  entrypoints: Map<string, Entrypoint | IEvaluatedEntrypoint>;\n  exports: Map<string, string[]>;\n}\n\ntype MapValue<T> = T extends Map<string, infer V> ? V : never;\n\nconst cacheLogger = linariaLogger.extend('cache');\n\nconst cacheNames = ['entrypoints', 'exports'] as const;\ntype CacheNames = (typeof cacheNames)[number];\n\nconst loggers = cacheNames.reduce(\n  (acc, key) => ({\n    ...acc,\n    [key]: cacheLogger.extend(key),\n  }),\n  {} as Record<CacheNames, typeof linariaLogger>\n);\n\nexport class TransformCacheCollection {\n  public readonly entrypoints: Map<string, Entrypoint | IEvaluatedEntrypoint>;\n\n  public readonly exports: Map<string, string[]>;\n\n  private contentHashes = new Map<string, string>();\n\n  constructor(caches: Partial<ICaches> = {}) {\n    this.entrypoints = caches.entrypoints || new Map();\n    this.exports = caches.exports || new Map();\n  }\n\n  public add<\n    TCache extends CacheNames,\n    TValue extends MapValue<ICaches[TCache]>,\n  >(cacheName: TCache, key: string, value: TValue): void {\n    const cache = this[cacheName] as Map<string, TValue>;\n    loggers[cacheName](\n      '%s:add %s %f',\n      getFileIdx(key).toString().padStart(5, '0'),\n      key,\n      () => {\n        if (!cache.has(key)) {\n          return 'added';\n        }\n\n        return cache.get(key) === value ? 'unchanged' : 'updated';\n      }\n    );\n\n    cache.set(key, value);\n  }\n\n  public clear(cacheName: CacheNames | 'all'): void {\n    if (cacheName === 'all') {\n      cacheNames.forEach((name) => {\n        this.clear(name);\n      });\n\n      return;\n    }\n\n    loggers[cacheName]('clear');\n    const cache = this[cacheName] as Map<string, unknown>;\n\n    cache.clear();\n  }\n\n  public delete(cacheName: CacheNames, key: string): void {\n    this.invalidate(cacheName, key);\n  }\n\n  public get<\n    TCache extends CacheNames,\n    TValue extends MapValue<ICaches[TCache]>,\n  >(cacheName: TCache, key: string): TValue | undefined {\n    const cache = this[cacheName] as Map<string, TValue>;\n\n    const res = cache.get(key);\n    loggers[cacheName]('get', key, res === undefined ? 'miss' : 'hit');\n    return res;\n  }\n\n  public has(cacheName: CacheNames, key: string): boolean {\n    const cache = this[cacheName] as Map<string, unknown>;\n\n    const res = cache.has(key);\n    loggers[cacheName]('has', key, res);\n    return res;\n  }\n\n  public invalidate(cacheName: CacheNames, key: string): void {\n    const cache = this[cacheName] as Map<string, unknown>;\n    if (!cache.has(key)) {\n      return;\n    }\n\n    loggers[cacheName]('invalidate', key);\n\n    cache.delete(key);\n  }\n\n  public invalidateForFile(filename: string) {\n    cacheNames.forEach((cacheName) => {\n      this.invalidate(cacheName, filename);\n    });\n  }\n\n  public invalidateIfChanged(filename: string, content: string) {\n    const hash = this.contentHashes.get(filename);\n    const newHash = hashContent(content);\n\n    if (hash !== newHash) {\n      cacheLogger('content has changed, invalidate all for %s', filename);\n      this.contentHashes.set(filename, newHash);\n      this.invalidateForFile(filename);\n\n      return true;\n    }\n\n    return false;\n  }\n}\n"],"mappings":"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"}