{"version":3,"file":"collector.js","names":["debug","invalidateTraversalCache","removeWithRelated","processTemplateExpression","filename","__filename","collector","file","options","values","processors","identifiers","path","traverse","Identifier","p","push","forEach","opts","processor","build","doRuntimeReplacement","length","prevalExport","scope","getData","findParent","isExpressionStatement","collectorPlugin","babel","Map","name","pre","metadata","linaria","replacements","rules","dependencies","visitor","post"],"sources":["../../src/plugins/collector.ts"],"sourcesContent":["/**\n * Collector traverses the AST and collects information about imports and\n * all Linaria template literals.\n */\n\nimport type { BabelFile, PluginObj } from '@babel/core';\nimport type { NodePath } from '@babel/traverse';\nimport type { Identifier } from '@babel/types';\n\nimport { debug } from '@linaria/logger';\nimport type { StrictOptions, LinariaMetadata } from '@linaria/utils';\nimport { invalidateTraversalCache, removeWithRelated } from '@linaria/utils';\n\nimport type { Core } from '../babel';\nimport type { IPluginState, ValueCache } from '../types';\nimport { processTemplateExpression } from '../utils/processTemplateExpression';\n\nexport const filename = __filename;\n\nexport function collector(\n  file: BabelFile,\n  options: Pick<\n    StrictOptions,\n    'classNameSlug' | 'displayName' | 'evaluate' | 'tagResolver'\n  >,\n  values: ValueCache\n) {\n  const processors: LinariaMetadata['processors'] = [];\n\n  const identifiers: NodePath<Identifier>[] = [];\n  file.path.traverse({\n    Identifier: (p) => {\n      identifiers.push(p);\n    },\n  });\n\n  // TODO: process transformed literals\n  identifiers.forEach((p) => {\n    processTemplateExpression(p, file.opts, options, (processor) => {\n      processor.build(values);\n      processor.doRuntimeReplacement();\n      processors.push(processor);\n    });\n  });\n\n  if (processors.length === 0) {\n    // We didn't find any Linaria template literals.\n    return processors;\n  }\n\n  // We can remove __linariaPreval export and all related code\n  const prevalExport = (\n    file.path.scope.getData('__linariaPreval') as NodePath | undefined\n  )?.findParent((p) => p.isExpressionStatement());\n  if (prevalExport) {\n    removeWithRelated([prevalExport]);\n  }\n\n  return processors;\n}\n\nexport default function collectorPlugin(\n  babel: Core,\n  options: StrictOptions & { values?: ValueCache }\n): PluginObj<IPluginState> {\n  const values = options.values ?? new Map<string, unknown>();\n  return {\n    name: '@linaria/babel/collector',\n    pre(file: BabelFile) {\n      debug('collect:start', file.opts.filename);\n\n      const processors = collector(file, options, values);\n\n      if (processors.length === 0) {\n        // We didn't find any Linaria template literals.\n        return;\n      }\n\n      this.file.metadata.linaria = {\n        processors,\n        replacements: [],\n        rules: {},\n        dependencies: [],\n      };\n\n      debug('collect:end', file.opts.filename);\n    },\n    visitor: {},\n    post(file: BabelFile) {\n      invalidateTraversalCache(file.path);\n    },\n  };\n}\n"],"mappings":"AAAA;AACA;AACA;AACA;;AAMA,SAASA,KAAK,QAAQ,iBAAiB;AAEvC,SAASC,wBAAwB,EAAEC,iBAAiB,QAAQ,gBAAgB;AAI5E,SAASC,yBAAyB,QAAQ,oCAAoC;AAE9E,OAAO,MAAMC,QAAQ,GAAGC,UAAU;AAElC,OAAO,SAASC,SAASA,CACvBC,IAAe,EACfC,OAGC,EACDC,MAAkB,EAClB;EACA,MAAMC,UAAyC,GAAG,EAAE;EAEpD,MAAMC,WAAmC,GAAG,EAAE;EAC9CJ,IAAI,CAACK,IAAI,CAACC,QAAQ,CAAC;IACjBC,UAAU,EAAGC,CAAC,IAAK;MACjBJ,WAAW,CAACK,IAAI,CAACD,CAAC,CAAC;IACrB;EACF,CAAC,CAAC;;EAEF;EACAJ,WAAW,CAACM,OAAO,CAAEF,CAAC,IAAK;IACzBZ,yBAAyB,CAACY,CAAC,EAAER,IAAI,CAACW,IAAI,EAAEV,OAAO,EAAGW,SAAS,IAAK;MAC9DA,SAAS,CAACC,KAAK,CAACX,MAAM,CAAC;MACvBU,SAAS,CAACE,oBAAoB,CAAC,CAAC;MAChCX,UAAU,CAACM,IAAI,CAACG,SAAS,CAAC;IAC5B,CAAC,CAAC;EACJ,CAAC,CAAC;EAEF,IAAIT,UAAU,CAACY,MAAM,KAAK,CAAC,EAAE;IAC3B;IACA,OAAOZ,UAAU;EACnB;;EAEA;EACA,MAAMa,YAAY,GAChBhB,IAAI,CAACK,IAAI,CAACY,KAAK,CAACC,OAAO,CAAC,iBAAiB,CAAC,EACzCC,UAAU,CAAEX,CAAC,IAAKA,CAAC,CAACY,qBAAqB,CAAC,CAAC,CAAC;EAC/C,IAAIJ,YAAY,EAAE;IAChBrB,iBAAiB,CAAC,CAACqB,YAAY,CAAC,CAAC;EACnC;EAEA,OAAOb,UAAU;AACnB;AAEA,eAAe,SAASkB,eAAeA,CACrCC,KAAW,EACXrB,OAAgD,EACvB;EACzB,MAAMC,MAAM,GAAGD,OAAO,CAACC,MAAM,IAAI,IAAIqB,GAAG,CAAkB,CAAC;EAC3D,OAAO;IACLC,IAAI,EAAE,0BAA0B;IAChCC,GAAGA,CAACzB,IAAe,EAAE;MACnBP,KAAK,CAAC,eAAe,EAAEO,IAAI,CAACW,IAAI,CAACd,QAAQ,CAAC;MAE1C,MAAMM,UAAU,GAAGJ,SAAS,CAACC,IAAI,EAAEC,OAAO,EAAEC,MAAM,CAAC;MAEnD,IAAIC,UAAU,CAACY,MAAM,KAAK,CAAC,EAAE;QAC3B;QACA;MACF;MAEA,IAAI,CAACf,IAAI,CAAC0B,QAAQ,CAACC,OAAO,GAAG;QAC3BxB,UAAU;QACVyB,YAAY,EAAE,EAAE;QAChBC,KAAK,EAAE,CAAC,CAAC;QACTC,YAAY,EAAE;MAChB,CAAC;MAEDrC,KAAK,CAAC,aAAa,EAAEO,IAAI,CAACW,IAAI,CAACd,QAAQ,CAAC;IAC1C,CAAC;IACDkC,OAAO,EAAE,CAAC,CAAC;IACXC,IAAIA,CAAChC,IAAe,EAAE;MACpBN,wBAAwB,CAACM,IAAI,CAACK,IAAI,CAAC;IACrC;EACF,CAAC;AACH"}