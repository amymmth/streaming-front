{"version":3,"file":"actionRunner.test.js","names":["createEntrypoint","createServices","getHandlers","processEntrypoint","asyncActionRunner","syncActionRunner","describe","services","beforeEach","it","expect","toBeDefined","handlers","entrypoint","action","createAction","undefined","toHaveBeenCalled","handler","jest","fn","handlerGenerator","imports","Map","entrypoint1","entrypoint2","toBe","action1","action2","task1","task2","Promise","all","toHaveBeenCalledTimes","resolveImports","resolveImportsData","valueCatcher","resolvedImports","source","only","resolved","result","toBeCalledTimes","toBeCalledWith","abortController","AbortController","abort","signal","Error","workflow","toThrowError","shouldNotBeCalled","processEntrypointMock","recover","e","toHaveBeenCalledWith","objectContaining","message","name","type","not","shouldBeCalled","code","sourceMap","fooBarDefault","explodeReexports"],"sources":["../../../../src/transform/actions/__tests__/actionRunner.test.ts"],"sourcesContent":["/* eslint-disable require-yield */\nimport type { IEntrypointDependency } from '../../Entrypoint.types';\nimport {\n  createEntrypoint,\n  createServices,\n  getHandlers,\n} from '../../__tests__/entrypoint-helpers';\nimport { processEntrypoint } from '../../generators/processEntrypoint';\nimport type {\n  Services,\n  IProcessEntrypointAction,\n  SyncScenarioForAction,\n  IResolveImportsAction,\n  IWorkflowAction,\n  YieldArg,\n  IExplodeReexportsAction,\n} from '../../types';\nimport type { BaseAction } from '../BaseAction';\nimport { asyncActionRunner, syncActionRunner } from '../actionRunner';\n\ndescribe('actionRunner', () => {\n  let services: Services;\n\n  beforeEach(() => {\n    services = createServices();\n  });\n\n  it('should be defined', () => {\n    expect(asyncActionRunner).toBeDefined();\n    expect(syncActionRunner).toBeDefined();\n  });\n\n  it('should run action', () => {\n    const handlers = getHandlers<'sync'>({});\n\n    const entrypoint = createEntrypoint(services, '/foo/bar.js', ['default']);\n    const action = entrypoint.createAction(\n      'processEntrypoint',\n      undefined,\n      null\n    );\n\n    syncActionRunner(action, handlers);\n    expect(handlers.processEntrypoint).toHaveBeenCalled();\n  });\n\n  it('should not run action if its copy was already run', async () => {\n    const handler = jest.fn();\n    function* handlerGenerator(\n      this: IProcessEntrypointAction\n    ): SyncScenarioForAction<IProcessEntrypointAction> {\n      handler();\n      yield ['resolveImports', this.entrypoint, { imports: new Map() }, null];\n    }\n\n    const handlers = getHandlers({\n      processEntrypoint: handlerGenerator,\n    });\n\n    const entrypoint1 = createEntrypoint(services, '/foo/bar.js', ['default']);\n    const entrypoint2 = createEntrypoint(services, '/foo/bar.js', ['default']);\n\n    expect(entrypoint1).toBe(entrypoint2);\n\n    const action1 = entrypoint1.createAction(\n      'processEntrypoint',\n      undefined,\n      null\n    );\n    const action2 = entrypoint2.createAction(\n      'processEntrypoint',\n      undefined,\n      null\n    );\n\n    expect(action1).toBe(action2);\n\n    const task1 = asyncActionRunner(action1, handlers);\n    const task2 = asyncActionRunner(action2, handlers);\n    await Promise.all([task1, task2]);\n\n    expect(handler).toHaveBeenCalledTimes(1);\n    expect(handlers.resolveImports).toHaveBeenCalledTimes(1);\n  });\n\n  it('should return value from yielded action', async () => {\n    const resolveImportsData = { imports: new Map() };\n\n    const valueCatcher = jest.fn();\n    const resolvedImports: IEntrypointDependency[] = [\n      {\n        source: './bar',\n        only: ['default'],\n        resolved: '/foo/bar.js',\n      },\n    ];\n\n    function* resolveImports(): SyncScenarioForAction<IResolveImportsAction> {\n      return resolvedImports;\n    }\n\n    const handlers = getHandlers({\n      *processEntrypoint(\n        this: IProcessEntrypointAction\n      ): SyncScenarioForAction<IProcessEntrypointAction> {\n        const result = yield [\n          'resolveImports',\n          this.entrypoint,\n          resolveImportsData,\n          null,\n        ];\n\n        valueCatcher(result);\n      },\n      resolveImports,\n    });\n\n    const entrypoint = createEntrypoint(services, '/foo/bar.js', ['default']);\n\n    const action = entrypoint.createAction(\n      'processEntrypoint',\n      undefined,\n      null\n    );\n\n    await asyncActionRunner(action, handlers);\n\n    expect(valueCatcher).toBeCalledTimes(1);\n    expect(valueCatcher).toBeCalledWith(resolvedImports);\n  });\n\n  it('should throw if action was aborted', () => {\n    const abortController = new AbortController();\n    abortController.abort();\n\n    function* handlerGenerator(\n      this: IWorkflowAction\n    ): SyncScenarioForAction<IWorkflowAction> {\n      yield [\n        'processEntrypoint',\n        this.entrypoint,\n        undefined,\n        abortController.signal,\n      ];\n\n      throw new Error('Should not be reached');\n    }\n\n    const handlers = getHandlers<'sync'>({\n      workflow: handlerGenerator,\n    });\n\n    const entrypoint = createEntrypoint(services, '/foo/bar.js', ['default']);\n    const action = entrypoint.createAction('workflow', undefined, null);\n\n    expect(() => syncActionRunner(action, handlers)).toThrowError(\n      'workflow@00001#1'\n    );\n  });\n\n  it('should call recover', () => {\n    const abortController = new AbortController();\n    abortController.abort();\n\n    function* workflow(\n      this: IWorkflowAction\n    ): SyncScenarioForAction<IWorkflowAction> {\n      yield [\n        'processEntrypoint',\n        this.entrypoint,\n        undefined,\n        abortController.signal,\n      ];\n\n      throw new Error('Should not be reached');\n    }\n\n    const shouldNotBeCalled = jest.fn();\n\n    function* processEntrypointMock(\n      this: IProcessEntrypointAction\n    ): SyncScenarioForAction<IProcessEntrypointAction> {\n      shouldNotBeCalled();\n    }\n\n    processEntrypointMock.recover = jest.fn<\n      YieldArg,\n      [e: unknown, action: BaseAction<IProcessEntrypointAction>]\n    >((e): YieldArg => {\n      throw e;\n    });\n\n    const handlers = getHandlers<'sync'>({\n      processEntrypoint: processEntrypointMock,\n      workflow,\n    });\n\n    const entrypoint = createEntrypoint(services, '/foo/bar.js', ['default']);\n    const action = entrypoint.createAction('workflow', undefined, null);\n\n    expect(() => syncActionRunner(action, handlers)).toThrowError(\n      'workflow@00001#1'\n    );\n\n    expect(processEntrypointMock.recover).toHaveBeenCalledWith(\n      expect.objectContaining({\n        message: 'workflow@00001#1',\n        name: 'AbortError',\n      }),\n      expect.objectContaining({ type: 'processEntrypoint' })\n    );\n    expect(shouldNotBeCalled).not.toHaveBeenCalled();\n  });\n\n  it('should recover', () => {\n    const abortController = new AbortController();\n    abortController.abort();\n\n    const shouldBeCalled = jest.fn();\n\n    function* workflow(\n      this: IWorkflowAction\n    ): SyncScenarioForAction<IWorkflowAction> {\n      yield [\n        'processEntrypoint',\n        this.entrypoint,\n        undefined,\n        abortController.signal,\n      ];\n\n      shouldBeCalled();\n\n      return {\n        code: '',\n        sourceMap: null,\n      };\n    }\n\n    function* processEntrypointMock(\n      this: IProcessEntrypointAction\n      // eslint-disable-next-line @typescript-eslint/no-empty-function\n    ): SyncScenarioForAction<IProcessEntrypointAction> {}\n\n    processEntrypointMock.recover = jest.fn<\n      YieldArg,\n      [e: unknown, action: BaseAction<IProcessEntrypointAction>]\n    >((e, action): YieldArg => {\n      return ['processEntrypoint', action.entrypoint, undefined, null];\n    });\n\n    const handlers = getHandlers<'sync'>({\n      processEntrypoint: processEntrypointMock,\n      workflow,\n    });\n\n    const entrypoint = createEntrypoint(services, '/foo/bar.js', ['default']);\n    const action = entrypoint.createAction('workflow', undefined, null);\n\n    syncActionRunner(action, handlers);\n    expect(processEntrypointMock.recover).toHaveBeenCalled();\n    expect(shouldBeCalled).toHaveBeenCalledTimes(1);\n  });\n\n  it('should process triple superseded entrypoint', () => {\n    const fooBarDefault = createEntrypoint(services, '/foo/bar.js', [\n      'default',\n    ]);\n\n    const handlers = getHandlers<'sync'>({\n      explodeReexports: function* explodeReexports(\n        this: IExplodeReexportsAction\n      ): SyncScenarioForAction<IExplodeReexportsAction> {\n        createEntrypoint(services, '/foo/bar.js', ['named']);\n        createEntrypoint(services, '/foo/bar.js', ['default', 'bar']);\n\n        yield ['getExports', this.entrypoint, undefined, null];\n      },\n      processEntrypoint,\n    });\n\n    const action = fooBarDefault.createAction(\n      'processEntrypoint',\n      undefined,\n      null\n    );\n\n    syncActionRunner(action, handlers);\n  });\n});\n"],"mappings":"AAAA;;AAEA,SACEA,gBAAgB,EAChBC,cAAc,EACdC,WAAW,QACN,oCAAoC;AAC3C,SAASC,iBAAiB,QAAQ,oCAAoC;AAWtE,SAASC,iBAAiB,EAAEC,gBAAgB,QAAQ,iBAAiB;AAErEC,QAAQ,CAAC,cAAc,EAAE,MAAM;EAC7B,IAAIC,QAAkB;EAEtBC,UAAU,CAAC,MAAM;IACfD,QAAQ,GAAGN,cAAc,CAAC,CAAC;EAC7B,CAAC,CAAC;EAEFQ,EAAE,CAAC,mBAAmB,EAAE,MAAM;IAC5BC,MAAM,CAACN,iBAAiB,CAAC,CAACO,WAAW,CAAC,CAAC;IACvCD,MAAM,CAACL,gBAAgB,CAAC,CAACM,WAAW,CAAC,CAAC;EACxC,CAAC,CAAC;EAEFF,EAAE,CAAC,mBAAmB,EAAE,MAAM;IAC5B,MAAMG,QAAQ,GAAGV,WAAW,CAAS,CAAC,CAAC,CAAC;IAExC,MAAMW,UAAU,GAAGb,gBAAgB,CAACO,QAAQ,EAAE,aAAa,EAAE,CAAC,SAAS,CAAC,CAAC;IACzE,MAAMO,MAAM,GAAGD,UAAU,CAACE,YAAY,CACpC,mBAAmB,EACnBC,SAAS,EACT,IACF,CAAC;IAEDX,gBAAgB,CAACS,MAAM,EAAEF,QAAQ,CAAC;IAClCF,MAAM,CAACE,QAAQ,CAACT,iBAAiB,CAAC,CAACc,gBAAgB,CAAC,CAAC;EACvD,CAAC,CAAC;EAEFR,EAAE,CAAC,mDAAmD,EAAE,YAAY;IAClE,MAAMS,OAAO,GAAGC,IAAI,CAACC,EAAE,CAAC,CAAC;IACzB,UAAUC,gBAAgBA,CAAA,EAEyB;MACjDH,OAAO,CAAC,CAAC;MACT,MAAM,CAAC,gBAAgB,EAAE,IAAI,CAACL,UAAU,EAAE;QAAES,OAAO,EAAE,IAAIC,GAAG,CAAC;MAAE,CAAC,EAAE,IAAI,CAAC;IACzE;IAEA,MAAMX,QAAQ,GAAGV,WAAW,CAAC;MAC3BC,iBAAiB,EAAEkB;IACrB,CAAC,CAAC;IAEF,MAAMG,WAAW,GAAGxB,gBAAgB,CAACO,QAAQ,EAAE,aAAa,EAAE,CAAC,SAAS,CAAC,CAAC;IAC1E,MAAMkB,WAAW,GAAGzB,gBAAgB,CAACO,QAAQ,EAAE,aAAa,EAAE,CAAC,SAAS,CAAC,CAAC;IAE1EG,MAAM,CAACc,WAAW,CAAC,CAACE,IAAI,CAACD,WAAW,CAAC;IAErC,MAAME,OAAO,GAAGH,WAAW,CAACT,YAAY,CACtC,mBAAmB,EACnBC,SAAS,EACT,IACF,CAAC;IACD,MAAMY,OAAO,GAAGH,WAAW,CAACV,YAAY,CACtC,mBAAmB,EACnBC,SAAS,EACT,IACF,CAAC;IAEDN,MAAM,CAACiB,OAAO,CAAC,CAACD,IAAI,CAACE,OAAO,CAAC;IAE7B,MAAMC,KAAK,GAAGzB,iBAAiB,CAACuB,OAAO,EAAEf,QAAQ,CAAC;IAClD,MAAMkB,KAAK,GAAG1B,iBAAiB,CAACwB,OAAO,EAAEhB,QAAQ,CAAC;IAClD,MAAMmB,OAAO,CAACC,GAAG,CAAC,CAACH,KAAK,EAAEC,KAAK,CAAC,CAAC;IAEjCpB,MAAM,CAACQ,OAAO,CAAC,CAACe,qBAAqB,CAAC,CAAC,CAAC;IACxCvB,MAAM,CAACE,QAAQ,CAACsB,cAAc,CAAC,CAACD,qBAAqB,CAAC,CAAC,CAAC;EAC1D,CAAC,CAAC;EAEFxB,EAAE,CAAC,yCAAyC,EAAE,YAAY;IACxD,MAAM0B,kBAAkB,GAAG;MAAEb,OAAO,EAAE,IAAIC,GAAG,CAAC;IAAE,CAAC;IAEjD,MAAMa,YAAY,GAAGjB,IAAI,CAACC,EAAE,CAAC,CAAC;IAC9B,MAAMiB,eAAwC,GAAG,CAC/C;MACEC,MAAM,EAAE,OAAO;MACfC,IAAI,EAAE,CAAC,SAAS,CAAC;MACjBC,QAAQ,EAAE;IACZ,CAAC,CACF;IAED,UAAUN,cAAcA,CAAA,EAAiD;MACvE,OAAOG,eAAe;IACxB;IAEA,MAAMzB,QAAQ,GAAGV,WAAW,CAAC;MAC3B,CAACC,iBAAiBA,CAAA,EAEiC;QACjD,MAAMsC,MAAM,GAAG,MAAM,CACnB,gBAAgB,EAChB,IAAI,CAAC5B,UAAU,EACfsB,kBAAkB,EAClB,IAAI,CACL;QAEDC,YAAY,CAACK,MAAM,CAAC;MACtB,CAAC;MACDP;IACF,CAAC,CAAC;IAEF,MAAMrB,UAAU,GAAGb,gBAAgB,CAACO,QAAQ,EAAE,aAAa,EAAE,CAAC,SAAS,CAAC,CAAC;IAEzE,MAAMO,MAAM,GAAGD,UAAU,CAACE,YAAY,CACpC,mBAAmB,EACnBC,SAAS,EACT,IACF,CAAC;IAED,MAAMZ,iBAAiB,CAACU,MAAM,EAAEF,QAAQ,CAAC;IAEzCF,MAAM,CAAC0B,YAAY,CAAC,CAACM,eAAe,CAAC,CAAC,CAAC;IACvChC,MAAM,CAAC0B,YAAY,CAAC,CAACO,cAAc,CAACN,eAAe,CAAC;EACtD,CAAC,CAAC;EAEF5B,EAAE,CAAC,oCAAoC,EAAE,MAAM;IAC7C,MAAMmC,eAAe,GAAG,IAAIC,eAAe,CAAC,CAAC;IAC7CD,eAAe,CAACE,KAAK,CAAC,CAAC;IAEvB,UAAUzB,gBAAgBA,CAAA,EAEgB;MACxC,MAAM,CACJ,mBAAmB,EACnB,IAAI,CAACR,UAAU,EACfG,SAAS,EACT4B,eAAe,CAACG,MAAM,CACvB;MAED,MAAM,IAAIC,KAAK,CAAC,uBAAuB,CAAC;IAC1C;IAEA,MAAMpC,QAAQ,GAAGV,WAAW,CAAS;MACnC+C,QAAQ,EAAE5B;IACZ,CAAC,CAAC;IAEF,MAAMR,UAAU,GAAGb,gBAAgB,CAACO,QAAQ,EAAE,aAAa,EAAE,CAAC,SAAS,CAAC,CAAC;IACzE,MAAMO,MAAM,GAAGD,UAAU,CAACE,YAAY,CAAC,UAAU,EAAEC,SAAS,EAAE,IAAI,CAAC;IAEnEN,MAAM,CAAC,MAAML,gBAAgB,CAACS,MAAM,EAAEF,QAAQ,CAAC,CAAC,CAACsC,YAAY,CAC3D,kBACF,CAAC;EACH,CAAC,CAAC;EAEFzC,EAAE,CAAC,qBAAqB,EAAE,MAAM;IAC9B,MAAMmC,eAAe,GAAG,IAAIC,eAAe,CAAC,CAAC;IAC7CD,eAAe,CAACE,KAAK,CAAC,CAAC;IAEvB,UAAUG,QAAQA,CAAA,EAEwB;MACxC,MAAM,CACJ,mBAAmB,EACnB,IAAI,CAACpC,UAAU,EACfG,SAAS,EACT4B,eAAe,CAACG,MAAM,CACvB;MAED,MAAM,IAAIC,KAAK,CAAC,uBAAuB,CAAC;IAC1C;IAEA,MAAMG,iBAAiB,GAAGhC,IAAI,CAACC,EAAE,CAAC,CAAC;IAEnC,UAAUgC,qBAAqBA,CAAA,EAEoB;MACjDD,iBAAiB,CAAC,CAAC;IACrB;IAEAC,qBAAqB,CAACC,OAAO,GAAGlC,IAAI,CAACC,EAAE,CAGpCkC,CAAC,IAAe;MACjB,MAAMA,CAAC;IACT,CAAC,CAAC;IAEF,MAAM1C,QAAQ,GAAGV,WAAW,CAAS;MACnCC,iBAAiB,EAAEiD,qBAAqB;MACxCH;IACF,CAAC,CAAC;IAEF,MAAMpC,UAAU,GAAGb,gBAAgB,CAACO,QAAQ,EAAE,aAAa,EAAE,CAAC,SAAS,CAAC,CAAC;IACzE,MAAMO,MAAM,GAAGD,UAAU,CAACE,YAAY,CAAC,UAAU,EAAEC,SAAS,EAAE,IAAI,CAAC;IAEnEN,MAAM,CAAC,MAAML,gBAAgB,CAACS,MAAM,EAAEF,QAAQ,CAAC,CAAC,CAACsC,YAAY,CAC3D,kBACF,CAAC;IAEDxC,MAAM,CAAC0C,qBAAqB,CAACC,OAAO,CAAC,CAACE,oBAAoB,CACxD7C,MAAM,CAAC8C,gBAAgB,CAAC;MACtBC,OAAO,EAAE,kBAAkB;MAC3BC,IAAI,EAAE;IACR,CAAC,CAAC,EACFhD,MAAM,CAAC8C,gBAAgB,CAAC;MAAEG,IAAI,EAAE;IAAoB,CAAC,CACvD,CAAC;IACDjD,MAAM,CAACyC,iBAAiB,CAAC,CAACS,GAAG,CAAC3C,gBAAgB,CAAC,CAAC;EAClD,CAAC,CAAC;EAEFR,EAAE,CAAC,gBAAgB,EAAE,MAAM;IACzB,MAAMmC,eAAe,GAAG,IAAIC,eAAe,CAAC,CAAC;IAC7CD,eAAe,CAACE,KAAK,CAAC,CAAC;IAEvB,MAAMe,cAAc,GAAG1C,IAAI,CAACC,EAAE,CAAC,CAAC;IAEhC,UAAU6B,QAAQA,CAAA,EAEwB;MACxC,MAAM,CACJ,mBAAmB,EACnB,IAAI,CAACpC,UAAU,EACfG,SAAS,EACT4B,eAAe,CAACG,MAAM,CACvB;MAEDc,cAAc,CAAC,CAAC;MAEhB,OAAO;QACLC,IAAI,EAAE,EAAE;QACRC,SAAS,EAAE;MACb,CAAC;IACH;IAEA,UAAUX,qBAAqBA,CAAA,EAGoB,CAAC;IAEpDA,qBAAqB,CAACC,OAAO,GAAGlC,IAAI,CAACC,EAAE,CAGrC,CAACkC,CAAC,EAAExC,MAAM,KAAe;MACzB,OAAO,CAAC,mBAAmB,EAAEA,MAAM,CAACD,UAAU,EAAEG,SAAS,EAAE,IAAI,CAAC;IAClE,CAAC,CAAC;IAEF,MAAMJ,QAAQ,GAAGV,WAAW,CAAS;MACnCC,iBAAiB,EAAEiD,qBAAqB;MACxCH;IACF,CAAC,CAAC;IAEF,MAAMpC,UAAU,GAAGb,gBAAgB,CAACO,QAAQ,EAAE,aAAa,EAAE,CAAC,SAAS,CAAC,CAAC;IACzE,MAAMO,MAAM,GAAGD,UAAU,CAACE,YAAY,CAAC,UAAU,EAAEC,SAAS,EAAE,IAAI,CAAC;IAEnEX,gBAAgB,CAACS,MAAM,EAAEF,QAAQ,CAAC;IAClCF,MAAM,CAAC0C,qBAAqB,CAACC,OAAO,CAAC,CAACpC,gBAAgB,CAAC,CAAC;IACxDP,MAAM,CAACmD,cAAc,CAAC,CAAC5B,qBAAqB,CAAC,CAAC,CAAC;EACjD,CAAC,CAAC;EAEFxB,EAAE,CAAC,6CAA6C,EAAE,MAAM;IACtD,MAAMuD,aAAa,GAAGhE,gBAAgB,CAACO,QAAQ,EAAE,aAAa,EAAE,CAC9D,SAAS,CACV,CAAC;IAEF,MAAMK,QAAQ,GAAGV,WAAW,CAAS;MACnC+D,gBAAgB,EAAE,UAAUA,gBAAgBA,CAAA,EAEM;QAChDjE,gBAAgB,CAACO,QAAQ,EAAE,aAAa,EAAE,CAAC,OAAO,CAAC,CAAC;QACpDP,gBAAgB,CAACO,QAAQ,EAAE,aAAa,EAAE,CAAC,SAAS,EAAE,KAAK,CAAC,CAAC;QAE7D,MAAM,CAAC,YAAY,EAAE,IAAI,CAACM,UAAU,EAAEG,SAAS,EAAE,IAAI,CAAC;MACxD,CAAC;MACDb;IACF,CAAC,CAAC;IAEF,MAAMW,MAAM,GAAGkD,aAAa,CAACjD,YAAY,CACvC,mBAAmB,EACnBC,SAAS,EACT,IACF,CAAC;IAEDX,gBAAgB,CAACS,MAAM,EAAEF,QAAQ,CAAC;EACpC,CAAC,CAAC;AACJ,CAAC,CAAC"}