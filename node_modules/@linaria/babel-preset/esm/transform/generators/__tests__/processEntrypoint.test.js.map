{"version":3,"file":"processEntrypoint.test.js","names":["createEntrypoint","createServices","processEntrypoint","expectIteratorReturnResult","expectIteratorYieldResult","isIteratorYieldResult","describe","services","beforeEach","it","fooBarDefault","action","createAction","undefined","gen","call","result","next","expect","value","toBe","emitted","filter","map","emittedSignals","a","signal","aborted","toEqual","supersededWith","nextResult","abortController","AbortController","abort"],"sources":["../../../../src/transform/generators/__tests__/processEntrypoint.test.ts"],"sourcesContent":["import {\n  createEntrypoint,\n  createServices,\n} from '../../__tests__/entrypoint-helpers';\nimport type { Services } from '../../types';\nimport { processEntrypoint } from '../processEntrypoint';\n\nimport {\n  expectIteratorReturnResult,\n  expectIteratorYieldResult,\n  isIteratorYieldResult,\n} from './helpers';\n\ndescribe('processEntrypoint', () => {\n  let services: Services;\n  beforeEach(() => {\n    services = createServices();\n  });\n\n  it('should emit explodeReexports, transform and finalizeEntrypoint actions', () => {\n    const fooBarDefault = createEntrypoint(services, '/foo/bar.js', [\n      'default',\n    ]);\n\n    // const action = createAction('processEntrypoint', fooBarDefault, {}, null);\n    const action = fooBarDefault.createAction(\n      'processEntrypoint',\n      undefined,\n      null\n    );\n    const gen = processEntrypoint.call(action);\n\n    let result = gen.next();\n    expectIteratorYieldResult(result);\n\n    expect(result.value[0]).toBe('explodeReexports');\n    expect(result.value[1]).toBe(fooBarDefault);\n\n    result = gen.next();\n    expectIteratorYieldResult(result);\n    expect(result.value[0]).toBe('transform');\n    expect(result.value[1]).toBe(fooBarDefault);\n\n    expectIteratorReturnResult(gen.next(), undefined);\n  });\n\n  it('should abort previously emitted actions if entrypoint was superseded and emit a new processEntrypoint', () => {\n    const fooBarDefault = createEntrypoint(services, '/foo/bar.js', [\n      'default',\n    ]);\n\n    const action = fooBarDefault.createAction(\n      'processEntrypoint',\n      undefined,\n      null\n    );\n    const gen = processEntrypoint.call(action);\n\n    const emitted = [gen.next(), gen.next()]\n      .filter(isIteratorYieldResult)\n      .map((result) => result.value);\n    expect(emitted[0][0]).toBe('explodeReexports');\n    expect(emitted[1][0]).toBe('transform');\n\n    const emittedSignals = emitted.map((a) => a[3]);\n    expect(emittedSignals.map((signal) => signal?.aborted)).toEqual([\n      false,\n      false,\n    ]);\n\n    const supersededWith = createEntrypoint(services, '/foo/bar.js', ['named']);\n    expect(emittedSignals.map((signal) => signal?.aborted)).toEqual([\n      true,\n      true,\n    ]);\n\n    const nextResult = gen.next();\n    expectIteratorYieldResult(nextResult);\n    expect(nextResult.value[0]).toBe('processEntrypoint');\n    expect(nextResult.value[1]).toBe(supersededWith);\n  });\n\n  it('should abort previously emitted actions if parent aborts', () => {\n    const fooBarDefault = createEntrypoint(services, '/foo/bar.js', [\n      'default',\n    ]);\n\n    const abortController = new AbortController();\n    const action = fooBarDefault.createAction(\n      'processEntrypoint',\n      undefined,\n      abortController.signal\n    );\n    const gen = processEntrypoint.call(action);\n\n    const emitted = [gen.next(), gen.next()]\n      .filter(isIteratorYieldResult)\n      .map((result) => result.value);\n    expect(emitted[0][0]).toBe('explodeReexports');\n    expect(emitted[1][0]).toBe('transform');\n\n    const emittedSignals = emitted.map((a) => a[3]);\n    expect(emittedSignals.map((signal) => signal?.aborted)).toEqual([\n      false,\n      false,\n    ]);\n\n    abortController.abort();\n\n    expect(emittedSignals.map((signal) => signal?.aborted)).toEqual([\n      true,\n      true,\n    ]);\n\n    expectIteratorReturnResult(gen.next(), undefined);\n  });\n});\n"],"mappings":"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"}