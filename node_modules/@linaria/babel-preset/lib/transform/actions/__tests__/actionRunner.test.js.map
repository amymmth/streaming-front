{"version":3,"file":"actionRunner.test.js","names":["_entrypointHelpers","require","_processEntrypoint","_actionRunner","describe","services","beforeEach","createServices","it","expect","asyncActionRunner","toBeDefined","syncActionRunner","handlers","getHandlers","entrypoint","createEntrypoint","action","createAction","undefined","processEntrypoint","toHaveBeenCalled","handler","jest","fn","handlerGenerator","imports","Map","entrypoint1","entrypoint2","toBe","action1","action2","task1","task2","Promise","all","toHaveBeenCalledTimes","resolveImports","resolveImportsData","valueCatcher","resolvedImports","source","only","resolved","result","toBeCalledTimes","toBeCalledWith","abortController","AbortController","abort","signal","Error","workflow","toThrowError","shouldNotBeCalled","processEntrypointMock","recover","e","toHaveBeenCalledWith","objectContaining","message","name","type","not","shouldBeCalled","code","sourceMap","fooBarDefault","explodeReexports"],"sources":["../../../../src/transform/actions/__tests__/actionRunner.test.ts"],"sourcesContent":["/* eslint-disable require-yield */\nimport type { IEntrypointDependency } from '../../Entrypoint.types';\nimport {\n  createEntrypoint,\n  createServices,\n  getHandlers,\n} from '../../__tests__/entrypoint-helpers';\nimport { processEntrypoint } from '../../generators/processEntrypoint';\nimport type {\n  Services,\n  IProcessEntrypointAction,\n  SyncScenarioForAction,\n  IResolveImportsAction,\n  IWorkflowAction,\n  YieldArg,\n  IExplodeReexportsAction,\n} from '../../types';\nimport type { BaseAction } from '../BaseAction';\nimport { asyncActionRunner, syncActionRunner } from '../actionRunner';\n\ndescribe('actionRunner', () => {\n  let services: Services;\n\n  beforeEach(() => {\n    services = createServices();\n  });\n\n  it('should be defined', () => {\n    expect(asyncActionRunner).toBeDefined();\n    expect(syncActionRunner).toBeDefined();\n  });\n\n  it('should run action', () => {\n    const handlers = getHandlers<'sync'>({});\n\n    const entrypoint = createEntrypoint(services, '/foo/bar.js', ['default']);\n    const action = entrypoint.createAction(\n      'processEntrypoint',\n      undefined,\n      null\n    );\n\n    syncActionRunner(action, handlers);\n    expect(handlers.processEntrypoint).toHaveBeenCalled();\n  });\n\n  it('should not run action if its copy was already run', async () => {\n    const handler = jest.fn();\n    function* handlerGenerator(\n      this: IProcessEntrypointAction\n    ): SyncScenarioForAction<IProcessEntrypointAction> {\n      handler();\n      yield ['resolveImports', this.entrypoint, { imports: new Map() }, null];\n    }\n\n    const handlers = getHandlers({\n      processEntrypoint: handlerGenerator,\n    });\n\n    const entrypoint1 = createEntrypoint(services, '/foo/bar.js', ['default']);\n    const entrypoint2 = createEntrypoint(services, '/foo/bar.js', ['default']);\n\n    expect(entrypoint1).toBe(entrypoint2);\n\n    const action1 = entrypoint1.createAction(\n      'processEntrypoint',\n      undefined,\n      null\n    );\n    const action2 = entrypoint2.createAction(\n      'processEntrypoint',\n      undefined,\n      null\n    );\n\n    expect(action1).toBe(action2);\n\n    const task1 = asyncActionRunner(action1, handlers);\n    const task2 = asyncActionRunner(action2, handlers);\n    await Promise.all([task1, task2]);\n\n    expect(handler).toHaveBeenCalledTimes(1);\n    expect(handlers.resolveImports).toHaveBeenCalledTimes(1);\n  });\n\n  it('should return value from yielded action', async () => {\n    const resolveImportsData = { imports: new Map() };\n\n    const valueCatcher = jest.fn();\n    const resolvedImports: IEntrypointDependency[] = [\n      {\n        source: './bar',\n        only: ['default'],\n        resolved: '/foo/bar.js',\n      },\n    ];\n\n    function* resolveImports(): SyncScenarioForAction<IResolveImportsAction> {\n      return resolvedImports;\n    }\n\n    const handlers = getHandlers({\n      *processEntrypoint(\n        this: IProcessEntrypointAction\n      ): SyncScenarioForAction<IProcessEntrypointAction> {\n        const result = yield [\n          'resolveImports',\n          this.entrypoint,\n          resolveImportsData,\n          null,\n        ];\n\n        valueCatcher(result);\n      },\n      resolveImports,\n    });\n\n    const entrypoint = createEntrypoint(services, '/foo/bar.js', ['default']);\n\n    const action = entrypoint.createAction(\n      'processEntrypoint',\n      undefined,\n      null\n    );\n\n    await asyncActionRunner(action, handlers);\n\n    expect(valueCatcher).toBeCalledTimes(1);\n    expect(valueCatcher).toBeCalledWith(resolvedImports);\n  });\n\n  it('should throw if action was aborted', () => {\n    const abortController = new AbortController();\n    abortController.abort();\n\n    function* handlerGenerator(\n      this: IWorkflowAction\n    ): SyncScenarioForAction<IWorkflowAction> {\n      yield [\n        'processEntrypoint',\n        this.entrypoint,\n        undefined,\n        abortController.signal,\n      ];\n\n      throw new Error('Should not be reached');\n    }\n\n    const handlers = getHandlers<'sync'>({\n      workflow: handlerGenerator,\n    });\n\n    const entrypoint = createEntrypoint(services, '/foo/bar.js', ['default']);\n    const action = entrypoint.createAction('workflow', undefined, null);\n\n    expect(() => syncActionRunner(action, handlers)).toThrowError(\n      'workflow@00001#1'\n    );\n  });\n\n  it('should call recover', () => {\n    const abortController = new AbortController();\n    abortController.abort();\n\n    function* workflow(\n      this: IWorkflowAction\n    ): SyncScenarioForAction<IWorkflowAction> {\n      yield [\n        'processEntrypoint',\n        this.entrypoint,\n        undefined,\n        abortController.signal,\n      ];\n\n      throw new Error('Should not be reached');\n    }\n\n    const shouldNotBeCalled = jest.fn();\n\n    function* processEntrypointMock(\n      this: IProcessEntrypointAction\n    ): SyncScenarioForAction<IProcessEntrypointAction> {\n      shouldNotBeCalled();\n    }\n\n    processEntrypointMock.recover = jest.fn<\n      YieldArg,\n      [e: unknown, action: BaseAction<IProcessEntrypointAction>]\n    >((e): YieldArg => {\n      throw e;\n    });\n\n    const handlers = getHandlers<'sync'>({\n      processEntrypoint: processEntrypointMock,\n      workflow,\n    });\n\n    const entrypoint = createEntrypoint(services, '/foo/bar.js', ['default']);\n    const action = entrypoint.createAction('workflow', undefined, null);\n\n    expect(() => syncActionRunner(action, handlers)).toThrowError(\n      'workflow@00001#1'\n    );\n\n    expect(processEntrypointMock.recover).toHaveBeenCalledWith(\n      expect.objectContaining({\n        message: 'workflow@00001#1',\n        name: 'AbortError',\n      }),\n      expect.objectContaining({ type: 'processEntrypoint' })\n    );\n    expect(shouldNotBeCalled).not.toHaveBeenCalled();\n  });\n\n  it('should recover', () => {\n    const abortController = new AbortController();\n    abortController.abort();\n\n    const shouldBeCalled = jest.fn();\n\n    function* workflow(\n      this: IWorkflowAction\n    ): SyncScenarioForAction<IWorkflowAction> {\n      yield [\n        'processEntrypoint',\n        this.entrypoint,\n        undefined,\n        abortController.signal,\n      ];\n\n      shouldBeCalled();\n\n      return {\n        code: '',\n        sourceMap: null,\n      };\n    }\n\n    function* processEntrypointMock(\n      this: IProcessEntrypointAction\n      // eslint-disable-next-line @typescript-eslint/no-empty-function\n    ): SyncScenarioForAction<IProcessEntrypointAction> {}\n\n    processEntrypointMock.recover = jest.fn<\n      YieldArg,\n      [e: unknown, action: BaseAction<IProcessEntrypointAction>]\n    >((e, action): YieldArg => {\n      return ['processEntrypoint', action.entrypoint, undefined, null];\n    });\n\n    const handlers = getHandlers<'sync'>({\n      processEntrypoint: processEntrypointMock,\n      workflow,\n    });\n\n    const entrypoint = createEntrypoint(services, '/foo/bar.js', ['default']);\n    const action = entrypoint.createAction('workflow', undefined, null);\n\n    syncActionRunner(action, handlers);\n    expect(processEntrypointMock.recover).toHaveBeenCalled();\n    expect(shouldBeCalled).toHaveBeenCalledTimes(1);\n  });\n\n  it('should process triple superseded entrypoint', () => {\n    const fooBarDefault = createEntrypoint(services, '/foo/bar.js', [\n      'default',\n    ]);\n\n    const handlers = getHandlers<'sync'>({\n      explodeReexports: function* explodeReexports(\n        this: IExplodeReexportsAction\n      ): SyncScenarioForAction<IExplodeReexportsAction> {\n        createEntrypoint(services, '/foo/bar.js', ['named']);\n        createEntrypoint(services, '/foo/bar.js', ['default', 'bar']);\n\n        yield ['getExports', this.entrypoint, undefined, null];\n      },\n      processEntrypoint,\n    });\n\n    const action = fooBarDefault.createAction(\n      'processEntrypoint',\n      undefined,\n      null\n    );\n\n    syncActionRunner(action, handlers);\n  });\n});\n"],"mappings":"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"}