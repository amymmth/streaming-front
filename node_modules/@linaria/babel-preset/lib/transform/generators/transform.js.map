{"version":3,"file":"transform.js","names":["_utils","require","_withLinariaMetadata","EMPTY_FILE","hasKeyInList","plugin","list","pluginKey","getPluginKey","some","i","includes","runPreevalStage","babel","evalConfig","pluginOptions","code","originalAst","eventEmitter","_evalConfig$plugins$f","_evalConfig$plugins","_evalConfig$plugins2","_result$ast","preShakePlugins","plugins","filter","highPriorityPlugins","resolve","transformConfig","buildOptions","envName","result","transformFromAstSync","ast","program","Error","prepareCode","services","item","log","only","loadedAndParsed","evaluator","_loadedAndParsed$code","options","preevalStageResult","perf","linariaMetadata","getLinariaMetadata","metadata","length","name","evaluatorConfig","onlyExports","features","transformedCode","imports","exports","internalTransform","prepareFn","entrypoint","_loadedAndParsed$code2","preparedCode","extend","_loadedAndParsed$code3","size","resolvedImports","getNext","resolved","transform","call"],"sources":["../../../src/transform/generators/transform.ts"],"sourcesContent":["import type {\n  BabelFileResult,\n  PluginItem,\n  TransformOptions,\n} from '@babel/core';\nimport type { File } from '@babel/types';\n\nimport type {\n  EvaluatorConfig,\n  EventEmitter,\n  LinariaMetadata,\n  StrictOptions,\n} from '@linaria/utils';\nimport { buildOptions, getPluginKey } from '@linaria/utils';\n\nimport type { Core } from '../../babel';\nimport { getLinariaMetadata } from '../../utils/withLinariaMetadata';\nimport type { Entrypoint } from '../Entrypoint';\nimport type {\n  ITransformAction,\n  Services,\n  SyncScenarioForAction,\n} from '../types';\n\nconst EMPTY_FILE = '=== empty file ===';\n\nconst hasKeyInList = (plugin: PluginItem, list: string[]): boolean => {\n  const pluginKey = getPluginKey(plugin);\n  return pluginKey ? list.some((i) => pluginKey.includes(i)) : false;\n};\n\nfunction runPreevalStage(\n  babel: Core,\n  evalConfig: TransformOptions,\n  pluginOptions: StrictOptions,\n  code: string,\n  originalAst: File,\n  eventEmitter: EventEmitter\n): BabelFileResult {\n  const preShakePlugins =\n    evalConfig.plugins?.filter((i) =>\n      hasKeyInList(i, pluginOptions.highPriorityPlugins)\n    ) ?? [];\n\n  const plugins = [\n    ...preShakePlugins,\n    [\n      require.resolve('../../plugins/preeval'),\n      { ...pluginOptions, eventEmitter },\n    ],\n    [require.resolve('../../plugins/dynamic-import')],\n    ...(evalConfig.plugins ?? []).filter(\n      (i) => !hasKeyInList(i, pluginOptions.highPriorityPlugins)\n    ),\n  ];\n\n  const transformConfig = buildOptions({\n    ...evalConfig,\n    envName: 'linaria',\n    plugins,\n  });\n\n  const result = babel.transformFromAstSync(originalAst, code, transformConfig);\n\n  if (!result || !result.ast?.program) {\n    throw new Error('Babel transform failed');\n  }\n\n  return result;\n}\n\ntype PrepareCodeFn = (\n  services: Services,\n  item: Entrypoint,\n  originalAst: File\n) => [\n  code: string,\n  imports: Map<string, string[]> | null,\n  metadata: LinariaMetadata | null,\n];\n\nexport const prepareCode = (\n  services: Services,\n  item: Entrypoint,\n  originalAst: File\n): ReturnType<PrepareCodeFn> => {\n  const { log, only, loadedAndParsed } = item;\n  if (loadedAndParsed.evaluator === 'ignored') {\n    log('is ignored');\n    return [loadedAndParsed.code ?? '', null, null];\n  }\n\n  const { code, evalConfig, evaluator } = loadedAndParsed;\n  const { options, babel, eventEmitter } = services;\n  const { pluginOptions } = options;\n\n  const preevalStageResult = eventEmitter.perf('transform:preeval', () =>\n    runPreevalStage(\n      babel,\n      evalConfig,\n      pluginOptions,\n      code,\n      originalAst,\n      eventEmitter\n    )\n  );\n\n  const linariaMetadata = getLinariaMetadata(preevalStageResult.metadata);\n\n  if (only.length === 1 && only[0] === '__linariaPreval' && !linariaMetadata) {\n    log('[evaluator:end] no metadata');\n    return [preevalStageResult.code!, null, null];\n  }\n\n  log('[preeval] metadata %O', linariaMetadata);\n  log('[evaluator:start] using %s', evaluator.name);\n\n  const evaluatorConfig: EvaluatorConfig = {\n    onlyExports: only,\n    highPriorityPlugins: pluginOptions.highPriorityPlugins,\n    features: pluginOptions.features,\n  };\n\n  const [, transformedCode, imports] = eventEmitter.perf(\n    'transform:evaluator',\n    () =>\n      evaluator(\n        evalConfig,\n        preevalStageResult.ast!,\n        preevalStageResult.code!,\n        evaluatorConfig,\n        babel\n      )\n  );\n\n  log('[evaluator:end]');\n\n  return [transformedCode, imports, linariaMetadata ?? null];\n};\n\nexport function* internalTransform(\n  this: ITransformAction,\n  prepareFn: PrepareCodeFn\n): SyncScenarioForAction<ITransformAction> {\n  const { only, loadedAndParsed, log } = this.entrypoint;\n  if (loadedAndParsed.evaluator === 'ignored') {\n    log('is ignored');\n    return {\n      code: loadedAndParsed.code ?? '',\n      metadata: null,\n    };\n  }\n\n  log('>> (%o)', only);\n\n  const [preparedCode, imports, metadata] = prepareFn(\n    this.services,\n    this.entrypoint,\n    loadedAndParsed.ast\n  );\n\n  if (loadedAndParsed.code === preparedCode) {\n    log('<< (%o)\\n === no changes ===', only);\n  } else {\n    log('<< (%o)', only);\n    log.extend('source')('%s', preparedCode || EMPTY_FILE);\n  }\n\n  if (preparedCode === '') {\n    log('is skipped');\n    return {\n      code: loadedAndParsed.code ?? '',\n      metadata: null,\n    };\n  }\n\n  if (imports !== null && imports.size > 0) {\n    const resolvedImports = yield* this.getNext(\n      'resolveImports',\n      this.entrypoint,\n      {\n        imports,\n      }\n    );\n\n    if (resolvedImports.length !== 0) {\n      yield [\n        'processImports',\n        this.entrypoint,\n        {\n          resolved: resolvedImports,\n        },\n      ];\n    }\n  }\n\n  return {\n    code: preparedCode,\n    metadata,\n  };\n}\n\n/**\n * Prepares the code for evaluation. This includes removing dead and potentially unsafe code.\n * Emits resolveImports and processImports events.\n */\nexport function transform(this: ITransformAction) {\n  return internalTransform.call(this, prepareCode);\n}\n"],"mappings":"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"}