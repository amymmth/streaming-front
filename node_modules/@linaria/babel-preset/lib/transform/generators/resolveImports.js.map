{"version":3,"file":"resolveImports.js","names":["_utils","require","_Entrypoint","emitDependency","emitter","entrypoint","imports","single","type","file","name","only","map","resolved","from","what","fileIdx","getFileIdx","toString","padStart","filterUnresolved","resolvedImports","filter","i","log","source","syncResolveImports","resolve","_imports$entries","data","services","eventEmitter","listOfImports","Array","entries","length","getStack","err","filteredImports","asyncResolveImports","_imports$entries2","getResolveTask","Promise","all","importsOnly","cached","getDependency","mergeOnly","task","newTask","then","res","isSuperSet","merged","addResolveTask","resolveTask"],"sources":["../../../src/transform/generators/resolveImports.ts"],"sourcesContent":["/* eslint-disable no-continue,no-await-in-loop,require-yield */\nimport { getFileIdx } from '@linaria/utils';\n\nimport type { Entrypoint } from '../Entrypoint';\nimport { getStack, isSuperSet, mergeOnly } from '../Entrypoint.helpers';\nimport type { IEntrypointDependency } from '../Entrypoint.types';\nimport type {\n  AsyncScenarioForAction,\n  IResolveImportsAction,\n  Services,\n  SyncScenarioForAction,\n} from '../types';\n\nfunction emitDependency(\n  emitter: Services['eventEmitter'],\n  entrypoint: IResolveImportsAction['entrypoint'],\n  imports: IEntrypointDependency[]\n) {\n  emitter.single({\n    type: 'dependency',\n    file: entrypoint.name,\n    only: entrypoint.only,\n    imports: imports.map(({ resolved, only }) => ({\n      from: resolved,\n      what: only,\n    })),\n    fileIdx: getFileIdx(entrypoint.name).toString().padStart(5, '0'),\n  });\n}\n\nfunction filterUnresolved(\n  entrypoint: Entrypoint,\n  resolvedImports: IEntrypointDependency[]\n): IEntrypointDependency[] {\n  return resolvedImports.filter((i): i is IEntrypointDependency => {\n    if (i.resolved === null) {\n      entrypoint.log(\n        `[resolve] ✅ %s in %s is ignored`,\n        i.source,\n        entrypoint.name\n      );\n      return false;\n    }\n\n    return true;\n  });\n}\n\n/**\n * Synchronously resolves specified imports with a provided resolver.\n */\nexport function* syncResolveImports(\n  this: IResolveImportsAction,\n  resolve: (what: string, importer: string, stack: string[]) => string\n): SyncScenarioForAction<IResolveImportsAction> {\n  const {\n    data: { imports },\n    entrypoint,\n    services: { eventEmitter },\n  } = this;\n  const listOfImports = Array.from(imports?.entries() ?? []);\n  const { log } = entrypoint;\n\n  if (listOfImports.length === 0) {\n    emitDependency(eventEmitter, entrypoint, []);\n\n    log('%s has no imports', entrypoint.name);\n    return [];\n  }\n\n  const resolvedImports = listOfImports.map(([source, only]) => {\n    let resolved: string | null = null;\n    try {\n      resolved = resolve(source, entrypoint.name, getStack(entrypoint));\n      log('[sync-resolve] ✅ %s -> %s (only: %o)', source, resolved, only);\n    } catch (err) {\n      log('[sync-resolve] ❌ cannot resolve %s: %O', source, err);\n    }\n\n    return {\n      source,\n      only,\n      resolved,\n    };\n  });\n\n  const filteredImports = filterUnresolved(entrypoint, resolvedImports);\n  emitDependency(eventEmitter, entrypoint, filteredImports);\n\n  return filteredImports;\n}\n\n/**\n * Asynchronously resolves specified imports with a provided resolver.\n */\nexport async function* asyncResolveImports(\n  this: IResolveImportsAction,\n  resolve: (\n    what: string,\n    importer: string,\n    stack: string[]\n  ) => Promise<string | null>\n): AsyncScenarioForAction<IResolveImportsAction> {\n  const {\n    data: { imports },\n    entrypoint,\n    services: { eventEmitter },\n  } = this;\n  const listOfImports = Array.from(imports?.entries() ?? []);\n  const { log } = entrypoint;\n\n  if (listOfImports.length === 0) {\n    emitDependency(eventEmitter, entrypoint, []);\n\n    log('%s has no imports', entrypoint.name);\n    return [];\n  }\n\n  log('resolving %d imports', listOfImports.length);\n\n  const getResolveTask = async (\n    source: string,\n    only: string[]\n  ): Promise<IEntrypointDependency> => {\n    let resolved: string | null = null;\n    try {\n      resolved = await resolve(source, entrypoint.name, getStack(entrypoint));\n    } catch (err) {\n      log(\n        '[async-resolve] ❌ cannot resolve %s in %s: %O',\n        source,\n        entrypoint.name,\n        err\n      );\n    }\n\n    if (resolved !== null) {\n      log(\n        '[async-resolve] ✅ %s (%o) in %s -> %s',\n        source,\n        only,\n        entrypoint.name,\n        resolved\n      );\n    }\n\n    return {\n      source,\n      only,\n      resolved,\n    };\n  };\n\n  const resolvedImports = await Promise.all<IEntrypointDependency>(\n    listOfImports.map(([source, importsOnly]) => {\n      const cached = entrypoint.getDependency(source);\n      if (cached) {\n        return {\n          source,\n          only: mergeOnly(cached.only, importsOnly),\n          resolved: cached.resolved,\n        };\n      }\n\n      const task = entrypoint.getResolveTask(source);\n      if (task) {\n        // If we have cached task, we need to merge only…\n        const newTask = task.then((res) => {\n          if (isSuperSet(res.only, importsOnly)) {\n            return res;\n          }\n\n          // Is this branch even possible?\n          const merged = mergeOnly(res.only, importsOnly);\n\n          log('merging imports %o and %o: %o', importsOnly, res.only, merged);\n\n          return { ...res, only: merged };\n        });\n\n        // … and update the cache\n        entrypoint.addResolveTask(source, newTask);\n        return newTask;\n      }\n\n      const resolveTask = getResolveTask(source, importsOnly);\n\n      entrypoint.addResolveTask(source, resolveTask);\n\n      return resolveTask;\n    })\n  );\n\n  log('resolved %d imports', resolvedImports.length);\n\n  const filteredImports = filterUnresolved(entrypoint, resolvedImports);\n  emitDependency(eventEmitter, entrypoint, filteredImports);\n  return filteredImports;\n}\n"],"mappings":"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"}