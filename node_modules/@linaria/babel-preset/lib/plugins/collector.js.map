{"version":3,"file":"collector.js","names":["_logger","require","_utils","_processTemplateExpression","filename","__filename","exports","collector","file","options","values","_file$path$scope$getD","processors","identifiers","path","traverse","Identifier","p","push","forEach","processTemplateExpression","opts","processor","build","doRuntimeReplacement","length","prevalExport","scope","getData","findParent","isExpressionStatement","removeWithRelated","collectorPlugin","babel","_options$values","Map","name","pre","debug","metadata","linaria","replacements","rules","dependencies","visitor","post","invalidateTraversalCache"],"sources":["../../src/plugins/collector.ts"],"sourcesContent":["/**\n * Collector traverses the AST and collects information about imports and\n * all Linaria template literals.\n */\n\nimport type { BabelFile, PluginObj } from '@babel/core';\nimport type { NodePath } from '@babel/traverse';\nimport type { Identifier } from '@babel/types';\n\nimport { debug } from '@linaria/logger';\nimport type { StrictOptions, LinariaMetadata } from '@linaria/utils';\nimport { invalidateTraversalCache, removeWithRelated } from '@linaria/utils';\n\nimport type { Core } from '../babel';\nimport type { IPluginState, ValueCache } from '../types';\nimport { processTemplateExpression } from '../utils/processTemplateExpression';\n\nexport const filename = __filename;\n\nexport function collector(\n  file: BabelFile,\n  options: Pick<\n    StrictOptions,\n    'classNameSlug' | 'displayName' | 'evaluate' | 'tagResolver'\n  >,\n  values: ValueCache\n) {\n  const processors: LinariaMetadata['processors'] = [];\n\n  const identifiers: NodePath<Identifier>[] = [];\n  file.path.traverse({\n    Identifier: (p) => {\n      identifiers.push(p);\n    },\n  });\n\n  // TODO: process transformed literals\n  identifiers.forEach((p) => {\n    processTemplateExpression(p, file.opts, options, (processor) => {\n      processor.build(values);\n      processor.doRuntimeReplacement();\n      processors.push(processor);\n    });\n  });\n\n  if (processors.length === 0) {\n    // We didn't find any Linaria template literals.\n    return processors;\n  }\n\n  // We can remove __linariaPreval export and all related code\n  const prevalExport = (\n    file.path.scope.getData('__linariaPreval') as NodePath | undefined\n  )?.findParent((p) => p.isExpressionStatement());\n  if (prevalExport) {\n    removeWithRelated([prevalExport]);\n  }\n\n  return processors;\n}\n\nexport default function collectorPlugin(\n  babel: Core,\n  options: StrictOptions & { values?: ValueCache }\n): PluginObj<IPluginState> {\n  const values = options.values ?? new Map<string, unknown>();\n  return {\n    name: '@linaria/babel/collector',\n    pre(file: BabelFile) {\n      debug('collect:start', file.opts.filename);\n\n      const processors = collector(file, options, values);\n\n      if (processors.length === 0) {\n        // We didn't find any Linaria template literals.\n        return;\n      }\n\n      this.file.metadata.linaria = {\n        processors,\n        replacements: [],\n        rules: {},\n        dependencies: [],\n      };\n\n      debug('collect:end', file.opts.filename);\n    },\n    visitor: {},\n    post(file: BabelFile) {\n      invalidateTraversalCache(file.path);\n    },\n  };\n}\n"],"mappings":";;;;;;;;AASA,IAAAA,OAAA,GAAAC,OAAA;AAEA,IAAAC,MAAA,GAAAD,OAAA;AAIA,IAAAE,0BAAA,GAAAF,OAAA;AAfA;AACA;AACA;AACA;;AAcO,MAAMG,QAAQ,GAAGC,UAAU;AAACC,OAAA,CAAAF,QAAA,GAAAA,QAAA;AAE5B,SAASG,SAASA,CACvBC,IAAe,EACfC,OAGC,EACDC,MAAkB,EAClB;EAAA,IAAAC,qBAAA;EACA,MAAMC,UAAyC,GAAG,EAAE;EAEpD,MAAMC,WAAmC,GAAG,EAAE;EAC9CL,IAAI,CAACM,IAAI,CAACC,QAAQ,CAAC;IACjBC,UAAU,EAAGC,CAAC,IAAK;MACjBJ,WAAW,CAACK,IAAI,CAACD,CAAC,CAAC;IACrB;EACF,CAAC,CAAC;;EAEF;EACAJ,WAAW,CAACM,OAAO,CAAEF,CAAC,IAAK;IACzB,IAAAG,oDAAyB,EAACH,CAAC,EAAET,IAAI,CAACa,IAAI,EAAEZ,OAAO,EAAGa,SAAS,IAAK;MAC9DA,SAAS,CAACC,KAAK,CAACb,MAAM,CAAC;MACvBY,SAAS,CAACE,oBAAoB,CAAC,CAAC;MAChCZ,UAAU,CAACM,IAAI,CAACI,SAAS,CAAC;IAC5B,CAAC,CAAC;EACJ,CAAC,CAAC;EAEF,IAAIV,UAAU,CAACa,MAAM,KAAK,CAAC,EAAE;IAC3B;IACA,OAAOb,UAAU;EACnB;;EAEA;EACA,MAAMc,YAAY,IAAAf,qBAAA,GAChBH,IAAI,CAACM,IAAI,CAACa,KAAK,CAACC,OAAO,CAAC,iBAAiB,CAAC,cAAAjB,qBAAA,uBADvBA,qBAAA,CAElBkB,UAAU,CAAEZ,CAAC,IAAKA,CAAC,CAACa,qBAAqB,CAAC,CAAC,CAAC;EAC/C,IAAIJ,YAAY,EAAE;IAChB,IAAAK,wBAAiB,EAAC,CAACL,YAAY,CAAC,CAAC;EACnC;EAEA,OAAOd,UAAU;AACnB;AAEe,SAASoB,eAAeA,CACrCC,KAAW,EACXxB,OAAgD,EACvB;EAAA,IAAAyB,eAAA;EACzB,MAAMxB,MAAM,IAAAwB,eAAA,GAAGzB,OAAO,CAACC,MAAM,cAAAwB,eAAA,cAAAA,eAAA,GAAI,IAAIC,GAAG,CAAkB,CAAC;EAC3D,OAAO;IACLC,IAAI,EAAE,0BAA0B;IAChCC,GAAGA,CAAC7B,IAAe,EAAE;MACnB,IAAA8B,aAAK,EAAC,eAAe,EAAE9B,IAAI,CAACa,IAAI,CAACjB,QAAQ,CAAC;MAE1C,MAAMQ,UAAU,GAAGL,SAAS,CAACC,IAAI,EAAEC,OAAO,EAAEC,MAAM,CAAC;MAEnD,IAAIE,UAAU,CAACa,MAAM,KAAK,CAAC,EAAE;QAC3B;QACA;MACF;MAEA,IAAI,CAACjB,IAAI,CAAC+B,QAAQ,CAACC,OAAO,GAAG;QAC3B5B,UAAU;QACV6B,YAAY,EAAE,EAAE;QAChBC,KAAK,EAAE,CAAC,CAAC;QACTC,YAAY,EAAE;MAChB,CAAC;MAED,IAAAL,aAAK,EAAC,aAAa,EAAE9B,IAAI,CAACa,IAAI,CAACjB,QAAQ,CAAC;IAC1C,CAAC;IACDwC,OAAO,EAAE,CAAC,CAAC;IACXC,IAAIA,CAACrC,IAAe,EAAE;MACpB,IAAAsC,+BAAwB,EAACtC,IAAI,CAACM,IAAI,CAAC;IACrC;EACF,CAAC;AACH"}