{"version":3,"file":"createVmContext.js","names":["vm","_interopRequireWildcard","require","_utils","process","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","NOOP","createWindow","Window","GlobalWindow","HappyWindow","win","Buffer","Uint8Array","createBaseContext","additionalContext","baseContext","document","window","self","top","parent","global","clearImmediate","clearInterval","clearTimeout","setImmediate","requestAnimationFrame","setInterval","setTimeout","createHappyDOMWindow","teardown","happyDOM","cancelAsync","createNothing","undefined","createVmContext","filename","features","overrideContext","i","isHappyDOMEnabled","isFeatureEnabled","__filename","context","createContext"],"sources":["../../src/vm/createVmContext.ts"],"sourcesContent":["import * as vm from 'vm';\n\nimport type { Window } from 'happy-dom';\n\nimport type { FeatureFlags, StrictOptions } from '@linaria/utils';\nimport { isFeatureEnabled } from '@linaria/utils';\n\nimport * as process from './process';\n\nconst NOOP = () => {};\n\nfunction createWindow(): Window {\n  const { Window, GlobalWindow } = require('happy-dom');\n  const HappyWindow = GlobalWindow || Window;\n  const win = new HappyWindow();\n\n  // TODO: browser doesn't expose Buffer, but a lot of dependencies use it\n  win.Buffer = Buffer;\n  win.Uint8Array = Uint8Array;\n\n  return win;\n}\n\nfunction createBaseContext(\n  win: Window | undefined,\n  additionalContext: Partial<vm.Context>\n): Partial<vm.Context> {\n  const baseContext: vm.Context = win ?? {};\n\n  baseContext.document = win?.document;\n  baseContext.window = win;\n  baseContext.self = win;\n  baseContext.top = win;\n  baseContext.parent = win;\n  baseContext.global = win;\n\n  baseContext.process = process;\n\n  baseContext.clearImmediate = NOOP;\n  baseContext.clearInterval = NOOP;\n  baseContext.clearTimeout = NOOP;\n  baseContext.setImmediate = NOOP;\n  baseContext.requestAnimationFrame = NOOP;\n  baseContext.setInterval = NOOP;\n  baseContext.setTimeout = NOOP;\n\n  // eslint-disable-next-line guard-for-in,no-restricted-syntax\n  for (const key in additionalContext) {\n    baseContext[key] = additionalContext[key];\n  }\n\n  return baseContext;\n}\n\nfunction createHappyDOMWindow() {\n  const win = createWindow();\n\n  return {\n    teardown: () => {\n      win.happyDOM.cancelAsync();\n    },\n    window: win,\n  };\n}\n\nfunction createNothing() {\n  return {\n    teardown: () => {},\n    window: undefined,\n  };\n}\n\nexport function createVmContext(\n  filename: string,\n  features: FeatureFlags<'happyDOM'>,\n  additionalContext: Partial<vm.Context>,\n  overrideContext: StrictOptions['overrideContext'] = (i) => i\n) {\n  const isHappyDOMEnabled = isFeatureEnabled(features, 'happyDOM', filename);\n\n  const { teardown, window } = isHappyDOMEnabled\n    ? createHappyDOMWindow()\n    : createNothing();\n  const baseContext = createBaseContext(\n    window,\n    overrideContext(\n      {\n        __filename: filename,\n        ...additionalContext,\n      },\n      filename\n    )\n  );\n\n  const context = vm.createContext(baseContext);\n\n  return {\n    context,\n    teardown,\n  };\n}\n"],"mappings":"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"}