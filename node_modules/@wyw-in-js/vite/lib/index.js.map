{"version":3,"file":"index.js","names":["_fs","require","_path","_interopRequireDefault","_vite","_shared","_transform","obj","__esModule","default","wywInJS","debug","include","exclude","sourceMap","preprocessor","rest","filter","createFilter","cssLookup","cssFileLookup","config","devServer","emitter","onDone","createFileReporter","targets","cache","TransformCacheCollection","name","enforce","buildEnd","process","cwd","configResolved","resolvedConfig","configureServer","_server","load","url","id","split","resolveId","importeeUrl","handleHotUpdate","ctx","modules","length","affected","x","dependencies","some","dep","file","m","deps","flatMap","target","depId","invalidateForFile","map","moduleGraph","getModuleById","concat","transform","code","_dependencies","_devServer","includes","log","logger","extend","getFileIdx","asyncResolve","what","importer","stack","resolved","resolve","external","resolvedId","syncResolve","startsWith","existsSync","optimizeDeps","Error","transformServices","options","filename","root","pluginOptions","eventEmitter","result","cssText","cssFilename","path","normalize","replace","posix","sep","cssRelativePath","relative","cssId","cssSourceMapText","Buffer","from","toString","JSON","stringify","i","end","depModule","isEntry","find","t","push","module","reloadModule"],"sources":["../src/index.ts"],"sourcesContent":["/**\n * This file contains a Vite loader for wyw-in-js.\n * It uses the transform.ts function to generate class names from source code,\n * returns transformed code without template literals and attaches generated source maps\n */\n\nimport { existsSync } from 'fs';\nimport path from 'path';\n\nimport { optimizeDeps, createFilter } from 'vite';\nimport type {\n  ModuleNode,\n  Plugin,\n  ResolvedConfig,\n  ViteDevServer,\n  FilterPattern,\n} from 'vite';\n\nimport { logger, syncResolve } from '@wyw-in-js/shared';\nimport type {\n  IFileReporterOptions,\n  PluginOptions,\n  Preprocessor,\n} from '@wyw-in-js/transform';\nimport {\n  createFileReporter,\n  getFileIdx,\n  transform,\n  TransformCacheCollection,\n} from '@wyw-in-js/transform';\n\ntype VitePluginOptions = {\n  debug?: IFileReporterOptions | false | null | undefined;\n  exclude?: FilterPattern;\n  include?: FilterPattern;\n  preprocessor?: Preprocessor;\n  sourceMap?: boolean;\n} & Partial<PluginOptions>;\n\nexport { Plugin };\n\nexport default function wywInJS({\n  debug,\n  include,\n  exclude,\n  sourceMap,\n  preprocessor,\n  ...rest\n}: VitePluginOptions = {}): Plugin {\n  const filter = createFilter(include, exclude);\n  const cssLookup: { [key: string]: string } = {};\n  const cssFileLookup: { [key: string]: string } = {};\n  let config: ResolvedConfig;\n  let devServer: ViteDevServer;\n\n  const { emitter, onDone } = createFileReporter(debug ?? false);\n\n  // <dependency id, targets>\n  const targets: { dependencies: string[]; id: string }[] = [];\n  const cache = new TransformCacheCollection();\n  return {\n    name: 'wyw-in-js',\n    enforce: 'post',\n    buildEnd() {\n      onDone(process.cwd());\n    },\n    configResolved(resolvedConfig: ResolvedConfig) {\n      config = resolvedConfig;\n    },\n    configureServer(_server) {\n      devServer = _server;\n    },\n    load(url: string) {\n      const [id] = url.split('?', 1);\n      return cssLookup[id];\n    },\n    /* eslint-disable-next-line consistent-return */\n    resolveId(importeeUrl: string) {\n      const [id] = importeeUrl.split('?', 1);\n      if (cssLookup[id]) return id;\n      return cssFileLookup[id];\n    },\n    handleHotUpdate(ctx) {\n      // it's module, so just transform it\n      if (ctx.modules.length) return ctx.modules;\n\n      // Select affected modules of changed dependency\n      const affected = targets.filter(\n        (x) =>\n          // file is dependency of any target\n          x.dependencies.some((dep) => dep === ctx.file) ||\n          // or changed module is a dependency of any target\n          x.dependencies.some((dep) => ctx.modules.some((m) => m.file === dep))\n      );\n      const deps = affected.flatMap((target) => target.dependencies);\n\n      // eslint-disable-next-line no-restricted-syntax\n      for (const depId of deps) {\n        cache.invalidateForFile(depId);\n      }\n\n      return affected\n        .map((target) => devServer.moduleGraph.getModuleById(target.id))\n        .concat(ctx.modules)\n        .filter((m): m is ModuleNode => !!m);\n    },\n    async transform(code: string, url: string) {\n      const [id] = url.split('?', 1);\n\n      // Do not transform ignored and generated files\n      if (url.includes('node_modules') || !filter(url) || id in cssLookup)\n        return;\n\n      const log = logger.extend('vite').extend(getFileIdx(id));\n\n      log('transform %s', id);\n\n      const asyncResolve = async (\n        what: string,\n        importer: string,\n        stack: string[]\n      ) => {\n        const resolved = await this.resolve(what, importer);\n        if (resolved) {\n          if (resolved.external) {\n            // If module is marked as external, Rollup will not resolve it,\n            // so we need to resolve it ourselves with default resolver\n            const resolvedId = syncResolve(what, importer, stack);\n            log(\"resolve ✅ '%s'@'%s -> %O\\n%s\", what, importer, resolved);\n            return resolvedId;\n          }\n\n          log(\"resolve ✅ '%s'@'%s -> %O\\n%s\", what, importer, resolved);\n          // Vite adds param like `?v=667939b3` to cached modules\n          const resolvedId = resolved.id.split('?', 1)[0];\n\n          if (resolvedId.startsWith('\\0')) {\n            // \\0 is a special character in Rollup that tells Rollup to not include this in the bundle\n            // https://rollupjs.org/guide/en/#outputexports\n            return null;\n          }\n\n          if (!existsSync(resolvedId)) {\n            await optimizeDeps(config);\n          }\n\n          return resolvedId;\n        }\n\n        log(\"resolve ❌ '%s'@'%s\", what, importer);\n        throw new Error(`Could not resolve ${what}`);\n      };\n\n      const transformServices = {\n        options: {\n          filename: id,\n          root: process.cwd(),\n          preprocessor,\n          pluginOptions: rest,\n        },\n        cache,\n        eventEmitter: emitter,\n      };\n\n      const result = await transform(transformServices, code, asyncResolve);\n\n      let { cssText, dependencies } = result;\n\n      // Heads up, there are three cases:\n      // 1. cssText is undefined, it means that file was not transformed\n      // 2. cssText is empty, it means that file was transformed, but it does not contain any styles\n      // 3. cssText is not empty, it means that file was transformed and it contains styles\n\n      if (typeof cssText === 'undefined') {\n        return;\n      }\n\n      if (cssText === '') {\n        /* eslint-disable-next-line consistent-return */\n        return {\n          code: result.code,\n          map: result.sourceMap,\n        };\n      }\n\n      dependencies ??= [];\n\n      const cssFilename = path\n        .normalize(`${id.replace(/\\.[jt]sx?$/, '')}.wyw-in-js.css`)\n        .replace(/\\\\/g, path.posix.sep);\n\n      const cssRelativePath = path\n        .relative(config.root, cssFilename)\n        .replace(/\\\\/g, path.posix.sep);\n\n      const cssId = `/${cssRelativePath}`;\n\n      if (sourceMap && result.cssSourceMapText) {\n        const map = Buffer.from(result.cssSourceMapText).toString('base64');\n        cssText += `/*# sourceMappingURL=data:application/json;base64,${map}*/`;\n      }\n\n      cssLookup[cssFilename] = cssText;\n      cssFileLookup[cssId] = cssFilename;\n\n      result.code += `\\nimport ${JSON.stringify(cssFilename)};\\n`;\n\n      for (let i = 0, end = dependencies.length; i < end; i++) {\n        // eslint-disable-next-line no-await-in-loop\n        const depModule = await this.resolve(dependencies[i], url, {\n          isEntry: false,\n        });\n        if (depModule) dependencies[i] = depModule.id;\n      }\n      const target = targets.find((t) => t.id === id);\n      if (!target) targets.push({ id, dependencies });\n      else target.dependencies = dependencies;\n\n      if (devServer?.moduleGraph) {\n        const module = devServer.moduleGraph.getModuleById(cssFilename);\n\n        if (module) {\n          devServer.reloadModule(module);\n        }\n      }\n      /* eslint-disable-next-line consistent-return */\n      return { code: result.code, map: result.sourceMap };\n    },\n  };\n}\n"],"mappings":"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"}